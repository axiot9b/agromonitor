name: Collect Copernicus Data

on:
  schedule:
    # Horarios (UTC) para Panamá (UTC-5):
    # 09:00 UTC = 04:00 AM Panamá (Madrugada)
    # 15:00 UTC = 10:00 AM Panamá (Mañana - Paso de Satélite)
    # 23:00 UTC = 06:00 PM Panamá (Tarde/Noche)
    - cron: '0 9,15,23 * * *'
  workflow_dispatch:  # Permite ejecución manual

jobs:
  collect-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sentinelhub cdsapi pandas pillow requests psycopg2-binary
        
    - name: Run Copernicus Collector
      env:
        SH_CLIENT_ID: ${{ secrets.SH_CLIENT_ID }}
        SH_CLIENT_SECRET: ${{ secrets.SH_CLIENT_SECRET }}
        CDS_API_URL: ${{ secrets.CDS_API_URL }}
        CDS_API_KEY: ${{ secrets.CDS_API_KEY }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
      run: |
        # Generar db_config.py dinámicamente para evitar subir credenciales al repo
        echo "import os" > db_config.py
        echo "import psycopg2" >> db_config.py
        echo "def get_connection():" >> db_config.py
        echo "    try:" >> db_config.py
        echo "        return psycopg2.connect(os.environ['DATABASE_URL'])" >> db_config.py
        echo "    except Exception as e:" >> db_config.py
        echo "        print(f'DB Error: {e}')" >> db_config.py
        echo "        return None" >> db_config.py
        
        # Ejecutar en modo NORMAL (completo) ya que tenemos cuota suficiente (30k)
        python copernicus_collector.py normal
        
    - name: Commit and Push changes
      run: |
        git config --global user.name 'AgroMonitor Bot'
        git config --global user.email 'bot@agromonitor.com'
        git add data/ quota_tracker.json
        git commit -m "Auto: Update Copernicus data and maps [skip ci]" || exit 0
        git push
