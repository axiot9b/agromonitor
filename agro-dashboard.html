<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroMonitor Pro - Dashboard Agr√≠cola</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: rgba(17, 24, 39, 0.8);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --border-glass: rgba(255, 255, 255, 0.1);
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-green: #10b981;
            --accent-blue: #3b82f6;
            --accent-yellow: #f59e0b;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --gradient-primary: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            --gradient-warm: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            --shadow-glow: 0 0 40px rgba(16, 185, 129, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
        }

        /* Header */
        .header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-glass);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .location-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-glass);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--border-glass);
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Config Panel */
        .config-panel {
            max-width: 500px;
            margin: 4rem auto;
            padding: 2rem;
        }

        .config-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: var(--shadow-glow);
        }

        .config-card h2 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .config-card p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        .btn-primary {
            width: 100%;
            padding: 1rem 2rem;
            background: var(--gradient-primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        /* Dashboard Grid */
        .dashboard {
            display: none;
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .dashboard.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-full {
            grid-template-columns: 1fr;
        }

        /* Cards */
        .card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 20px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: var(--shadow-glow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .card-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient-primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .card-icon.yellow {
            background: var(--gradient-warm);
        }

        .card-icon.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }

        .card-icon.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
        }

        /* Stat Cards */
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
        }

        /* Weather Section */
        .weather-main {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .weather-temp {
            font-size: 4rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .weather-icon {
            font-size: 4rem;
        }

        .weather-desc {
            font-size: 1.25rem;
            color: var(--text-secondary);
            text-transform: capitalize;
        }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .weather-item {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }

        .weather-item-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .weather-item-value {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .weather-item-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Forecast Section */
        .forecast-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
        }

        .forecast-day {
            background: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .forecast-day:hover {
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.02);
        }

        .forecast-day.active {
            background: var(--gradient-primary);
        }

        .forecast-date {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .forecast-icon {
            font-size: 2rem;
            margin: 0.5rem 0;
        }

        .forecast-temp {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .forecast-rain {
            font-size: 0.75rem;
            color: var(--accent-blue);
        }

        /* API Limits Panel */
        .limits-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .limit-item {
            background: var(--bg-secondary);
            padding: 1.25rem;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .limit-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-green);
        }

        .limit-item.warning::before {
            background: var(--accent-yellow);
        }

        .limit-item.critical::before {
            background: var(--accent-red);
        }

        .limit-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .limit-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .limit-max {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Map */
        #map {
            height: 400px;
            border-radius: 16px;
            overflow: hidden;
        }

        /* Index Cards */
        .index-display {
            text-align: center;
            padding: 1rem 0;
        }

        .index-value {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .index-bar {
            height: 8px;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            border-radius: 4px;
            margin: 1rem 0;
            position: relative;
        }

        .index-marker {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateX(-50%);
            transition: left 0.5s ease;
        }

        .index-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Soil Section */
        .soil-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .soil-stat {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .soil-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .soil-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .soil-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Alerts */
        .alerts-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--accent-green);
        }

        .alert.warning {
            border-left-color: var(--accent-yellow);
        }

        .alert.error {
            border-left-color: var(--accent-red);
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Chart */
        .chart-container {
            height: 250px;
            margin-top: 1rem;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-glass);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Last Update */
        .last-update {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 0.5rem;
        }

        /* ==========================================
           NEW: REFRESH INDICATOR & BUTTON
        ========================================== */
        .refresh-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1.5rem;
        }

        .refresh-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .refresh-dot {
            width: 10px;
            height: 10px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse-glow 2s infinite;
        }

        .refresh-dot.stale {
            background: var(--accent-yellow);
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
        }

        .refresh-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .refresh-time {
            color: var(--text-primary);
            font-weight: 600;
        }

        .btn-refresh {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-glass);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-refresh:hover {
            background: var(--accent-green);
            border-color: var(--accent-green);
        }

        .btn-refresh.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        /* ==========================================
           NEW: TEMPERATURE GAUGE (Circular)
        ========================================== */
        .temp-gauge-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .temp-gauge {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .temp-gauge svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .temp-gauge-bg {
            fill: none;
            stroke: var(--bg-secondary);
            stroke-width: 10;
        }

        .temp-gauge-fill {
            fill: none;
            stroke: url(#tempGradient);
            stroke-width: 10;
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s ease;
        }

        .temp-gauge-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .temp-gauge-number {
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .temp-gauge-unit {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ==========================================
           NEW: HUMIDITY TANK METER
        ========================================== */
        .tank-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .tank-meter {
            position: relative;
            width: 60px;
            height: 120px;
            background: var(--bg-secondary);
            border-radius: 30px;
            overflow: hidden;
            border: 2px solid var(--border-glass);
        }

        .tank-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(180deg, #3b82f6 0%, #0ea5e9 100%);
            border-radius: 0 0 28px 28px;
            transition: height 1s ease;
        }

        .tank-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%);
            animation: wave 2s ease-in-out infinite;
        }

        @keyframes wave {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        .tank-markers {
            position: absolute;
            right: -25px;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 0.625rem;
            color: var(--text-muted);
        }

        .tank-info {
            flex: 1;
        }

        .tank-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .tank-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .tank-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .tank-status.optimal {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
        }

        .tank-status.low {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
        }

        .tank-status.high {
            background: rgba(245, 158, 11, 0.1);
            color: var(--accent-yellow);
        }

        /* ==========================================
           NEW: SPARKLINES
        ========================================== */
        .sparkline-container {
            height: 40px;
            margin-top: 0.75rem;
        }

        .sparkline {
            width: 100%;
            height: 100%;
        }

        .sparkline-line {
            fill: none;
            stroke: var(--accent-green);
            stroke-width: 2;
            stroke-linecap: round;
        }

        .sparkline-area {
            fill: url(#sparklineGradient);
            opacity: 0.3;
        }

        /* ==========================================
           NEW: ANIMATED WEATHER ICONS
        ========================================== */
        .weather-icon-animated {
            font-size: 5rem;
            position: relative;
            display: inline-block;
        }

        .weather-icon-animated.sunny {
            animation: sunny-bounce 3s ease-in-out infinite;
        }

        @keyframes sunny-bounce {

            0%,
            100% {
                transform: scale(1) rotate(0deg);
            }

            50% {
                transform: scale(1.1) rotate(5deg);
            }
        }

        .weather-icon-animated.rainy::after {
            content: 'üíß';
            position: absolute;
            font-size: 1rem;
            animation: rain-drop 1s ease-in-out infinite;
            left: 50%;
            top: 80%;
        }

        @keyframes rain-drop {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        .weather-icon-animated.cloudy {
            animation: cloudy-float 4s ease-in-out infinite;
        }

        @keyframes cloudy-float {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(5px);
            }
        }

        /* ==========================================
           NEW: CARD ENTRANCE ANIMATIONS
        ========================================== */
        .card {
            animation: card-enter 0.5s ease backwards;
        }

        @keyframes card-enter {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .grid-4 .card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .grid-4 .card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .grid-4 .card:nth-child(3) {
            animation-delay: 0.3s;
        }

        .grid-4 .card:nth-child(4) {
            animation-delay: 0.4s;
        }

        /* ==========================================
           NEW: WIND PARTICLES OVERLAY
        ========================================== */
        .wind-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .wind-particle {
            position: absolute;
            width: 30px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: wind-blow 3s linear infinite;
        }

        @keyframes wind-blow {
            0% {
                transform: translateX(-100px) translateY(0);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                transform: translateX(calc(100% + 100px)) translateY(-20px);
                opacity: 0;
            }
        }

        /* Map container with wind */
        .map-container {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
        }

        #map {
            height: 400px;
            border-radius: 16px;
            overflow: hidden;
        }

        /* ==========================================
           NEW: PREMIUM HOVER EFFECTS
        ========================================== */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card {
            position: relative;
            overflow: hidden;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }

            .weather-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .forecast-container {
                grid-template-columns: repeat(3, 1fr);
            }

            .limits-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .header-info {
                flex-direction: column;
                gap: 0.5rem;
            }

            .grid-4,
            .grid-3,
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .weather-main {
                flex-direction: column;
                text-align: center;
            }

            .weather-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .forecast-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .limits-grid {
                grid-template-columns: 1fr;
            }

            .soil-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="bg-animation"></div>

    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üå±</div>
                <h1>AgroMonitor Pro</h1>
            </div>
            <div class="header-info">
                <div class="location-badge">
                    <span>üìç</span>
                    <span>Veraguas, Panam√°</span>
                    <span>‚Ä¢</span>
                    <span>2 Hect√°reas</span>
                    <span>‚Ä¢</span>
                    <span>379.62 msnm</span>
                </div>
                <div class="location-badge">
                    <div class="status-dot"></div>
                    <span id="connectionStatus">Conectando...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard - Se inicia autom√°ticamente -->
    <div class="dashboard" id="dashboard">

        <!-- SVG Gradients for Gauges -->
        <svg style="position: absolute; width: 0; height: 0;">
            <defs>
                <linearGradient id="tempGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#10b981" />
                    <stop offset="100%" style="stop-color:#3b82f6" />
                </linearGradient>
                <linearGradient id="sparklineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.5" />
                    <stop offset="100%" style="stop-color:#10b981;stop-opacity:0" />
                </linearGradient>
            </defs>
        </svg>

        <!-- Refresh Indicator Bar -->
        <div class="refresh-bar">
            <div class="refresh-info">
                <div class="refresh-dot" id="refreshDot"></div>
                <span class="refresh-text">
                    √öltima actualizaci√≥n: <span class="refresh-time" id="lastRefreshTime">--</span>
                </span>
            </div>
            <button class="btn-refresh" id="btnRefresh" onclick="refreshAllData()">
                <span class="refresh-icon">üîÑ</span>
                <span>Actualizar</span>
            </button>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-4">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üå°Ô∏è</div>
                        <span>Temperatura</span>
                    </div>
                </div>
                <div class="stat-value" id="tempValue">--¬∞C</div>
                <div class="stat-label">Sensaci√≥n: <span id="feelsLike">--¬∞C</span></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon yellow">üíß</div>
                        <span>Humedad</span>
                    </div>
                </div>
                <div class="stat-value" id="humidityValue">--%</div>
                <div class="stat-label">Punto de roc√≠o: <span id="dewPoint">--¬∞C</span></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon blue">üåø</div>
                        <span>NDVI</span>
                    </div>
                </div>
                <div class="stat-value" id="ndviValue">--</div>
                <div class="stat-label" id="ndviStatus">Cargando...</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon purple">üåç</div>
                        <span>Humedad Suelo</span>
                    </div>
                </div>
                <div class="stat-value" id="soilMoistureValue">--%</div>
                <div class="stat-label" id="soilStatus">Cargando...</div>
            </div>
        </div>

        <!-- Weather & Forecast -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon yellow">‚òÄÔ∏è</div>
                        <span>Clima Actual</span>
                    </div>
                    <span class="last-update" id="weatherUpdate">--</span>
                </div>
                <div id="weatherContent" class="loading">
                    <div class="spinner"></div>
                    <span>Cargando clima...</span>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon blue">üìÖ</div>
                        <span>Pron√≥stico 5 D√≠as</span>
                    </div>
                </div>
                <div id="forecastContent" class="loading">
                    <div class="spinner"></div>
                    <span>Cargando pron√≥stico...</span>
                </div>
            </div>
        </div>

        <!-- Map & Soil -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üó∫Ô∏è</div>
                        <span>Tu Finca</span>
                    </div>
                </div>
                <div id="map"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon purple">üåç</div>
                        <span>Datos del Suelo</span>
                    </div>
                    <span class="last-update" id="soilUpdate">--</span>
                </div>
                <div id="soilContent" class="loading">
                    <div class="spinner"></div>
                    <span>Cargando datos del suelo...</span>
                </div>
            </div>
        </div>

        <!-- NDVI & Alerts -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üìä</div>
                        <span>Hist√≥rico NDVI (30 d√≠as)</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="ndviChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon yellow">üîî</div>
                        <span>Alertas y Recomendaciones</span>
                    </div>
                </div>
                <div id="alertsContent" class="alerts-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Analizando condiciones...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Temperature Chart (Min/Max + NDVI) -->
        <div class="grid grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üå°Ô∏è</div>
                        <span>Temperatura Diaria (M√≠n/M√°x) + NDVI - Pr√≥ximos 5 d√≠as</span>
                    </div>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="tempNdviChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: Precipitation Charts -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon blue">üåßÔ∏è</div>
                        <span>Precipitaci√≥n Diaria (mm)</span>
                    </div>
                </div>
                <div class="chart-container" style="height: 280px;">
                    <canvas id="precipChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon purple">üíß</div>
                        <span>Precipitaci√≥n Acumulada (mm)</span>
                    </div>
                </div>
                <div class="chart-container" style="height: 280px;">
                    <canvas id="accumPrecipChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: Historical Collected Data -->
        <div class="grid grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon yellow">üìà</div>
                        <span>Datos Hist√≥ricos Recolectados (Temperatura)</span>
                    </div>
                    <span class="last-update">√öltimas 24h</span>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="historicalTempChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: Historical Humidity -->
        <div class="grid grid-2">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon blue">üíß</div>
                        <span>Humedad Hist√≥rica (%)</span>
                    </div>
                </div>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="historicalHumidityChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üå¨Ô∏è</div>
                        <span>Viento Hist√≥rico (m/s)</span>
                    </div>
                </div>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="historicalWindChart"></canvas>
                </div>
            </div>
        </div>

        <!-- NEW: OpenWeather Comparison -->
        <div class="grid grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon purple">‚öñÔ∏è</div>
                        <span>Comparaci√≥n: Agromonitoring vs OpenWeather</span>
                    </div>
                    <span class="last-update" id="comparisonUpdate">--</span>
                </div>
                <div id="comparisonContent">
                    <div class="weather-grid" style="grid-template-columns: repeat(2, 1fr); gap: 2rem;">
                        <div
                            style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 12px;">
                            <h4 style="color: var(--accent-green); margin-bottom: 1rem;">üåø Agromonitoring</h4>
                            <div class="stat-value" id="agroTemp">--¬∞C</div>
                            <div class="stat-label">Humedad: <span id="agroHumidity">--%</span></div>
                        </div>
                        <div
                            style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 12px;">
                            <h4 style="color: var(--accent-yellow); margin-bottom: 1rem;">‚òÄÔ∏è OpenWeather</h4>
                            <div class="stat-value" id="owTemp">--¬∞C</div>
                            <div class="stat-label">Humedad: <span id="owHumidity">--%</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API Limits -->
        <div class="grid grid-full">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üìà</div>
                        <span>L√≠mites del API - Plan Gratuito</span>
                    </div>
                </div>
                <div class="limits-grid">
                    <div class="limit-item">
                        <div class="limit-label">üõ∞Ô∏è Datos Satelitales</div>
                        <div class="limit-value">
                            < 60</div>
                                <div class="limit-max">llamadas/minuto</div>
                        </div>
                        <div class="limit-item">
                            <div class="limit-label">‚òÄÔ∏è Weather API</div>
                            <div class="limit-value">
                                < 500</div>
                                    <div class="limit-max">llamadas/d√≠a</div>
                            </div>
                            <div class="limit-item">
                                <div class="limit-label">üì¶ Pol√≠gonos</div>
                                <div class="limit-value">
                                    < 10</div>
                                        <div class="limit-max">creados/mes</div>
                                </div>
                                <div class="limit-item">
                                    <div class="limit-label">üåç Actualizaci√≥n Suelo</div>
                                    <div class="limit-value">2x</div>
                                    <div class="limit-max">por d√≠a</div>
                                </div>
                                <div class="limit-item">
                                    <div class="limit-label">‚è±Ô∏è Actualizaci√≥n Weather</div>
                                    <div class="limit-value">
                                        < 2</div>
                                            <div class="limit-max">horas</div>
                                    </div>
                                    <div class="limit-item">
                                        <div class="limit-label">üì° Im√°genes Satelitales</div>
                                        <div class="limit-value">3-5</div>
                                        <div class="limit-max">d√≠as entre actualizaciones</div>
                                    </div>
                                </div>
                                <div class="last-update" style="margin-top: 1rem;">
                                    Licencia: CC BY-SA 4.0 | Base de datos: ODbL
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        // ============================================
                        // CONFIGURACI√ìN AUTOM√ÅTICA - polygon_config.json
                        // ============================================
                        const CONFIG = {
                            api_key: '6892cb4b5a99f53f4a0927d98cf05d61',
                            polygon_id: '69810584a049de7a8d4b4156',
                            polygon_name: 'los valles',
                            location: {
                                lat: 8.439227,
                                lon: -81.191935,
                                altitude: 379.62,
                                region: 'Veraguas, Panam√°'
                            }
                        };

                        // Variables globales
                        let apiKey = CONFIG.api_key;
                        let polygonId = CONFIG.polygon_id;
                        let map = null;

                        const farmCenter = [CONFIG.location.lat, CONFIG.location.lon];
                        const farmPolygon = [
                            [8.440, -81.193],
                            [8.440, -81.190],
                            [8.438, -81.190],
                            [8.438, -81.193],
                            [8.440, -81.193]
                        ];

                        // Weather icons map
                        const weatherIcons = {
                            'Clear': '‚òÄÔ∏è',
                            'Clouds': '‚òÅÔ∏è',
                            'Rain': 'üåßÔ∏è',
                            'Drizzle': 'üå¶Ô∏è',
                            'Thunderstorm': '‚õàÔ∏è',
                            'Snow': '‚ùÑÔ∏è',
                            'Mist': 'üå´Ô∏è',
                            'Fog': 'üå´Ô∏è'
                        };

                        // AUTO-INICIALIZAR al cargar la p√°gina
                        document.addEventListener('DOMContentLoaded', async function () {
                            console.log('üå± AgroMonitor Pro - Iniciando autom√°ticamente...');
                            console.log('üìç Pol√≠gono:', CONFIG.polygon_name);

                            // Mostrar dashboard directamente
                            document.getElementById('dashboard').classList.add('active');
                            document.getElementById('connectionStatus').textContent = 'En l√≠nea';

                            // Initialize map
                            initMap();

                            // Load all data
                            await loadAllData();

                            // Auto-refresh every 10 minutes
                            setInterval(loadAllData, 600000);
                        });

                        function initMap() {
                            map = L.map('map').setView(farmCenter, 15);

                            // Base layer - Dark theme
                            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                                attribution: '¬© OpenStreetMap, ¬© CartoDB'
                            }).addTo(map);

                            // OpenWeather Wind Layer
                            const openWeatherKey = 'ca45f79113069e3524b4877bebe6e0dd';
                            L.tileLayer(`https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${openWeatherKey}`, {
                                attribution: '¬© OpenWeatherMap',
                                opacity: 0.5
                            }).addTo(map);

                            // Optional: Add precipitation layer
                            L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${openWeatherKey}`, {
                                attribution: '¬© OpenWeatherMap',
                                opacity: 0.3
                            }).addTo(map);

                            // Farm polygon
                            const polygon = L.polygon(farmPolygon, {
                                color: '#10b981',
                                fillColor: '#10b981',
                                fillOpacity: 0.3,
                                weight: 2
                            }).addTo(map);

                            L.marker(farmCenter).addTo(map)
                                .bindPopup('<b>Tu Finca</b><br>2 hect√°reas<br>Veraguas, Panam√°');

                            map.fitBounds(polygon.getBounds());

                            // Add wind particles overlay
                            createWindParticles();
                        }

                        // Create animated wind particles
                        function createWindParticles() {
                            const mapContainer = document.getElementById('map');
                            const overlay = document.createElement('div');
                            overlay.className = 'wind-overlay';

                            for (let i = 0; i < 8; i++) {
                                const particle = document.createElement('div');
                                particle.className = 'wind-particle';
                                particle.style.top = `${Math.random() * 100}%`;
                                particle.style.animationDelay = `${Math.random() * 3}s`;
                                particle.style.animationDuration = `${2 + Math.random() * 2}s`;
                                overlay.appendChild(particle);
                            }

                            mapContainer.style.position = 'relative';
                            mapContainer.appendChild(overlay);
                        }

                        // Track last update time
                        let lastUpdateTime = null;

                        async function loadAllData() {
                            await Promise.all([
                                loadWeather(),
                                loadForecast(),
                                loadSoilData(),
                                loadNDVI(),
                                loadNDVIHistory(),
                                generateAlerts(),
                                loadTemperatureNdviChart(),
                                loadPrecipitationCharts(),
                                loadHistoricalData(),
                                loadOpenWeatherComparison()
                            ]);

                            // Update last refresh time
                            lastUpdateTime = new Date();
                            updateRefreshIndicator();
                        }

                        // Refresh all data with button animation
                        async function refreshAllData() {
                            const btn = document.getElementById('btnRefresh');
                            btn.classList.add('loading');
                            btn.disabled = true;

                            try {
                                await loadAllData();
                            } finally {
                                btn.classList.remove('loading');
                                btn.disabled = false;
                            }
                        }

                        // Update the refresh indicator
                        function updateRefreshIndicator() {
                            if (!lastUpdateTime) return;

                            const now = new Date();
                            const diffMs = now - lastUpdateTime;
                            const diffMins = Math.floor(diffMs / 60000);

                            const timeText = document.getElementById('lastRefreshTime');
                            const dot = document.getElementById('refreshDot');

                            if (diffMins < 1) {
                                timeText.textContent = 'Ahora mismo';
                            } else if (diffMins === 1) {
                                timeText.textContent = 'Hace 1 minuto';
                            } else if (diffMins < 60) {
                                timeText.textContent = `Hace ${diffMins} minutos`;
                            } else {
                                const hours = Math.floor(diffMins / 60);
                                timeText.textContent = `Hace ${hours}h ${diffMins % 60}m`;
                            }

                            // Mark as stale if more than 15 minutes
                            if (diffMins > 15) {
                                dot.classList.add('stale');
                            } else {
                                dot.classList.remove('stale');
                            }
                        }

                        // Update indicator every minute
                        setInterval(updateRefreshIndicator, 60000);

                        async function loadWeather() {
                            try {
                                const response = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/weather?polyid=${polygonId}&appid=${apiKey}`
                                );
                                const data = await response.json();

                                const temp = Math.round(data.main.temp - 273.15);
                                const feelsLike = Math.round(data.main.feels_like - 273.15);
                                const humidity = data.main.humidity;
                                const pressure = data.main.pressure;
                                const windSpeed = data.wind.speed;
                                const windDeg = data.wind.deg || 0;
                                const clouds = data.clouds.all;
                                const visibility = data.visibility ? (data.visibility / 1000).toFixed(1) : 'N/A';
                                const weatherDesc = data.weather[0].description;
                                const weatherMain = data.weather[0].main;

                                // Calculate dew point
                                const dewPoint = Math.round(temp - ((100 - humidity) / 5));

                                // Update quick stats
                                document.getElementById('tempValue').textContent = `${temp}¬∞C`;
                                document.getElementById('feelsLike').textContent = `${feelsLike}¬∞C`;
                                document.getElementById('humidityValue').textContent = `${humidity}%`;
                                document.getElementById('dewPoint').textContent = `${dewPoint}¬∞C`;

                                // Full weather display
                                const windDirection = getWindDirection(windDeg);

                                const html = `
                    <div class="weather-main">
                        <div class="weather-icon">${weatherIcons[weatherMain] || 'üå§Ô∏è'}</div>
                        <div>
                            <div class="weather-temp">${temp}¬∞C</div>
                            <div class="weather-desc">${weatherDesc}</div>
                        </div>
                    </div>
                    <div class="weather-grid">
                        <div class="weather-item">
                            <div class="weather-item-icon">üå°Ô∏è</div>
                            <div class="weather-item-value">${feelsLike}¬∞C</div>
                            <div class="weather-item-label">Sensaci√≥n</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-item-icon">üíß</div>
                            <div class="weather-item-value">${humidity}%</div>
                            <div class="weather-item-label">Humedad</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-item-icon">üå¨Ô∏è</div>
                            <div class="weather-item-value">${windSpeed} m/s</div>
                            <div class="weather-item-label">${windDirection}</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-item-icon">üìä</div>
                            <div class="weather-item-value">${pressure}</div>
                            <div class="weather-item-label">hPa</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-item-icon">‚òÅÔ∏è</div>
                            <div class="weather-item-value">${clouds}%</div>
                            <div class="weather-item-label">Nubosidad</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-item-icon">üëÅÔ∏è</div>
                            <div class="weather-item-value">${visibility}</div>
                            <div class="weather-item-label">km Visib.</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-item-icon">üí¶</div>
                            <div class="weather-item-value">${dewPoint}¬∞C</div>
                            <div class="weather-item-label">P. Roc√≠o</div>
                        </div>
                        <div class="weather-item">
                            <div class="weather-item-icon">üß≠</div>
                            <div class="weather-item-value">${windDeg}¬∞</div>
                            <div class="weather-item-label">Dir. Viento</div>
                        </div>
                    </div>
                `;

                                document.getElementById('weatherContent').innerHTML = html;
                                document.getElementById('weatherUpdate').textContent =
                                    `Actualizado: ${new Date().toLocaleTimeString('es-PA')}`;

                            } catch (error) {
                                console.error('Error loading weather:', error);
                                document.getElementById('weatherContent').innerHTML =
                                    '<p style="color: var(--accent-red);">Error cargando datos del clima</p>';
                            }
                        }

                        async function loadForecast() {
                            try {
                                const response = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/weather/forecast?polyid=${polygonId}&appid=${apiKey}`
                                );
                                const data = await response.json();

                                // Group by day
                                const dailyData = {};
                                data.forEach(item => {
                                    const date = new Date(item.dt * 1000);
                                    const dayKey = date.toLocaleDateString('es-PA', { weekday: 'short', day: 'numeric' });

                                    if (!dailyData[dayKey]) {
                                        dailyData[dayKey] = {
                                            temps: [],
                                            weather: item.weather[0].main,
                                            rain: 0
                                        };
                                    }

                                    dailyData[dayKey].temps.push(item.main.temp - 273.15);
                                    if (item.rain && item.rain['3h']) {
                                        dailyData[dayKey].rain += item.rain['3h'];
                                    }
                                });

                                const html = `
                    <div class="forecast-container">
                        ${Object.entries(dailyData).slice(0, 5).map(([day, data]) => {
                                    const avgTemp = Math.round(data.temps.reduce((a, b) => a + b, 0) / data.temps.length);
                                    return `
                                <div class="forecast-day">
                                    <div class="forecast-date">${day}</div>
                                    <div class="forecast-icon">${weatherIcons[data.weather] || 'üå§Ô∏è'}</div>
                                    <div class="forecast-temp">${avgTemp}¬∞C</div>
                                    ${data.rain > 0 ? `<div class="forecast-rain">üíß ${data.rain.toFixed(1)}mm</div>` : ''}
                                </div>
                            `;
                                }).join('')}
                    </div>
                `;

                                document.getElementById('forecastContent').innerHTML = html;

                            } catch (error) {
                                console.error('Error loading forecast:', error);
                                document.getElementById('forecastContent').innerHTML =
                                    '<p style="color: var(--accent-red);">Error cargando pron√≥stico</p>';
                            }
                        }

                        async function loadSoilData() {
                            try {
                                const response = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/soil?polyid=${polygonId}&appid=${apiKey}`
                                );
                                const data = await response.json();

                                const soilTemp = (data.t10 - 273.15).toFixed(1);
                                const soilMoisture = (data.moisture * 100).toFixed(0);

                                // Update quick stat
                                document.getElementById('soilMoistureValue').textContent = `${soilMoisture}%`;

                                let moistureStatus = '√ìptimo';
                                if (soilMoisture < 30) moistureStatus = '‚ö†Ô∏è Bajo';
                                else if (soilMoisture > 70) moistureStatus = '‚ö†Ô∏è Alto';
                                document.getElementById('soilStatus').textContent = moistureStatus;

                                const html = `
                    <div class="soil-stats">
                        <div class="soil-stat">
                            <div class="soil-icon">üå°Ô∏è</div>
                            <div class="soil-value">${soilTemp}¬∞C</div>
                            <div class="soil-label">Temperatura (10cm)</div>
                        </div>
                        <div class="soil-stat">
                            <div class="soil-icon">üíß</div>
                            <div class="soil-value">${soilMoisture}%</div>
                            <div class="soil-label">Humedad</div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <div class="limit-label">Estado del suelo</div>
                        <div class="index-bar" style="background: linear-gradient(90deg, #8B4513, #10b981, #3b82f6);">
                            <div class="index-marker" style="left: ${soilMoisture}%;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted);">
                            <span>Seco</span>
                            <span>√ìptimo</span>
                            <span>Saturado</span>
                        </div>
                    </div>
                `;

                                document.getElementById('soilContent').innerHTML = html;
                                document.getElementById('soilUpdate').textContent =
                                    `Actualizado: ${new Date(data.dt * 1000).toLocaleString('es-PA')}`;

                            } catch (error) {
                                console.error('Error loading soil data:', error);
                                document.getElementById('soilContent').innerHTML =
                                    '<p style="color: var(--accent-red);">Error cargando datos del suelo</p>';
                            }
                        }

                        async function loadNDVI() {
                            try {
                                const end = Math.floor(Date.now() / 1000);
                                const start = end - (30 * 24 * 60 * 60);

                                const response = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/image/search?start=${start}&end=${end}&polyid=${polygonId}&appid=${apiKey}`
                                );
                                const images = await response.json();

                                if (images.length > 0 && images[0].stats.ndvi) {
                                    const statsResponse = await fetch(images[0].stats.ndvi);
                                    const stats = await statsResponse.json();

                                    const ndviValue = stats.mean || 0;
                                    document.getElementById('ndviValue').textContent = ndviValue.toFixed(3);

                                    let status = 'Excelente';
                                    if (ndviValue < 0.2) status = '‚ö†Ô∏è Bajo';
                                    else if (ndviValue < 0.4) status = 'Moderado';
                                    else if (ndviValue < 0.6) status = 'Saludable';
                                    else if (ndviValue < 0.8) status = 'Muy bueno';

                                    document.getElementById('ndviStatus').textContent = status;
                                } else {
                                    document.getElementById('ndviValue').textContent = 'N/A';
                                    document.getElementById('ndviStatus').textContent = 'Sin datos recientes';
                                }

                            } catch (error) {
                                console.error('Error loading NDVI:', error);
                                document.getElementById('ndviValue').textContent = 'Error';
                            }
                        }

                        async function loadNDVIHistory() {
                            try {
                                const end = Math.floor(Date.now() / 1000);
                                const start = end - (30 * 24 * 60 * 60);

                                const response = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/image/search?start=${start}&end=${end}&polyid=${polygonId}&appid=${apiKey}`
                                );
                                const images = await response.json();

                                const ndviData = [];
                                const labels = [];

                                for (const image of images) {
                                    if (image.stats && image.stats.ndvi) {
                                        try {
                                            const statsResponse = await fetch(image.stats.ndvi);
                                            const stats = await statsResponse.json();

                                            ndviData.push(stats.mean || 0);
                                            labels.push(new Date(image.dt * 1000).toLocaleDateString('es-PA', {
                                                month: 'short',
                                                day: 'numeric'
                                            }));
                                        } catch (e) {
                                            console.log('Error getting stats for image');
                                        }
                                    }
                                }

                                ndviData.reverse();
                                labels.reverse();

                                const ctx = document.getElementById('ndviChart').getContext('2d');

                                if (window.ndviChart && typeof window.ndviChart.destroy === 'function') {
                                    window.ndviChart.destroy();
                                }

                                window.ndviChart = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'NDVI',
                                            data: ndviData,
                                            borderColor: '#10b981',
                                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                            borderWidth: 3,
                                            fill: true,
                                            tension: 0.4,
                                            pointRadius: 4,
                                            pointBackgroundColor: '#10b981'
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: false }
                                        },
                                        scales: {
                                            y: {
                                                min: -0.2,
                                                max: 1,
                                                ticks: { color: '#9ca3af' },
                                                grid: { color: 'rgba(255,255,255,0.05)' }
                                            },
                                            x: {
                                                ticks: { color: '#9ca3af' },
                                                grid: { display: false }
                                            }
                                        }
                                    }
                                });

                            } catch (error) {
                                console.error('Error loading NDVI history:', error);
                            }
                        }

                        async function generateAlerts() {
                            try {
                                const alerts = [];

                                // Get weather data
                                const weatherResponse = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/weather?polyid=${polygonId}&appid=${apiKey}`
                                );
                                const weather = await weatherResponse.json();

                                // Get soil data
                                const soilResponse = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/soil?polyid=${polygonId}&appid=${apiKey}`
                                );
                                const soil = await soilResponse.json();

                                const temp = weather.main.temp - 273.15;
                                const moisture = soil.moisture * 100;

                                // Temperature alerts
                                if (temp > 32) {
                                    alerts.push({
                                        type: 'warning',
                                        icon: 'üå°Ô∏è',
                                        title: 'Temperatura Alta',
                                        message: `${temp.toFixed(1)}¬∞C - Aumentar riego en hortalizas`
                                    });
                                }

                                // Soil moisture alerts
                                if (moisture < 30) {
                                    alerts.push({
                                        type: 'warning',
                                        icon: 'üíß',
                                        title: 'Suelo Seco',
                                        message: `Humedad ${moisture.toFixed(0)}% - Programar riego pronto`
                                    });
                                } else if (moisture > 70) {
                                    alerts.push({
                                        type: 'warning',
                                        icon: 'üåä',
                                        title: 'Suelo Saturado',
                                        message: `Humedad ${moisture.toFixed(0)}% - Verificar drenaje`
                                    });
                                } else {
                                    alerts.push({
                                        type: 'success',
                                        icon: '‚úÖ',
                                        title: 'Humedad √ìptima',
                                        message: `Suelo en condiciones ideales (${moisture.toFixed(0)}%)`
                                    });
                                }

                                // Crop recommendations
                                alerts.push({
                                    type: 'info',
                                    icon: 'üçå',
                                    title: 'Pl√°tano',
                                    message: 'Revisar hojas para signos de Sigatoka'
                                });

                                alerts.push({
                                    type: 'info',
                                    icon: 'üå∂Ô∏è',
                                    title: 'Hortalizas',
                                    message: 'Continuar calendario de fertilizaci√≥n'
                                });

                                // Render alerts
                                const html = alerts.map(alert => `
                    <div class="alert ${alert.type}">
                        <div class="alert-icon">${alert.icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-message">${alert.message}</div>
                        </div>
                    </div>
                `).join('');

                                document.getElementById('alertsContent').innerHTML = html;

                            } catch (error) {
                                console.error('Error generating alerts:', error);
                                document.getElementById('alertsContent').innerHTML =
                                    '<p style="color: var(--accent-red);">Error generando alertas</p>';
                            }
                        }

                        function getWindDirection(deg) {
                            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SO', 'O', 'NO'];
                            const index = Math.round(deg / 45) % 8;
                            return directions[index];
                        }

                        // ============================================
                        // NEW: Temperature + NDVI Chart (Daily)
                        // ============================================
                        async function loadTemperatureNdviChart() {
                            try {
                                // Get forecast data
                                const forecastResponse = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/weather/forecast?polyid=${polygonId}&appid=${apiKey}`
                                );
                                const forecastData = await forecastResponse.json();

                                // Get NDVI history
                                const end = Math.floor(Date.now() / 1000);
                                const start = end - (30 * 24 * 60 * 60);
                                const ndviResponse = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/image/search?start=${start}&end=${end}&polyid=${polygonId}&appid=${apiKey}`
                                );
                                const ndviImages = await ndviResponse.json();

                                // Process forecast by day (get min/max)
                                const dailyData = {};
                                forecastData.forEach(item => {
                                    const date = new Date(item.dt * 1000);
                                    const dayKey = date.toLocaleDateString('es-PA', {
                                        weekday: 'short',
                                        day: 'numeric',
                                        month: 'short'
                                    });

                                    if (!dailyData[dayKey]) {
                                        dailyData[dayKey] = {
                                            temps: [],
                                            date: date
                                        };
                                    }
                                    dailyData[dayKey].temps.push(item.main.temp - 273.15);
                                });

                                // Calculate min/max for each day
                                const labels = [];
                                const minTemps = [];
                                const maxTemps = [];

                                Object.entries(dailyData).slice(0, 5).forEach(([day, data]) => {
                                    labels.push(day);
                                    minTemps.push(Math.round(Math.min(...data.temps)));
                                    maxTemps.push(Math.round(Math.max(...data.temps)));
                                });

                                // Get last NDVI value to show as reference line
                                let lastNdvi = null;
                                if (ndviImages.length > 0 && ndviImages[0].stats.ndvi) {
                                    try {
                                        const statsResponse = await fetch(ndviImages[0].stats.ndvi);
                                        const stats = await statsResponse.json();
                                        lastNdvi = stats.mean;
                                    } catch (e) {
                                        console.log('Could not get NDVI stats');
                                    }
                                }

                                // Create chart
                                const ctx = document.getElementById('tempNdviChart').getContext('2d');

                                if (window.tempNdviChart && typeof window.tempNdviChart.destroy === 'function') {
                                    window.tempNdviChart.destroy();
                                }

                                const datasets = [
                                    {
                                        label: 'Temp. M√°xima (¬∞C)',
                                        data: maxTemps,
                                        borderColor: '#ef4444',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.3,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: 'Temp. M√≠nima (¬∞C)',
                                        data: minTemps,
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        borderWidth: 3,
                                        fill: false,
                                        tension: 0.3,
                                        yAxisID: 'y'
                                    }
                                ];

                                // Add NDVI as horizontal reference if available
                                if (lastNdvi !== null) {
                                    datasets.push({
                                        label: `NDVI Actual (${lastNdvi.toFixed(2)})`,
                                        data: labels.map(() => lastNdvi * 40), // Scale NDVI to temp range
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        borderWidth: 2,
                                        borderDash: [5, 5],
                                        fill: false,
                                        pointRadius: 0,
                                        yAxisID: 'y1'
                                    });
                                }

                                window.tempNdviChart = new Chart(ctx, {
                                    type: 'line',
                                    data: { labels, datasets },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        interaction: {
                                            mode: 'index',
                                            intersect: false
                                        },
                                        plugins: {
                                            legend: {
                                                labels: { color: '#9ca3af' }
                                            },
                                            tooltip: {
                                                backgroundColor: 'rgba(17, 24, 39, 0.9)',
                                                titleColor: '#f9fafb',
                                                bodyColor: '#9ca3af'
                                            }
                                        },
                                        scales: {
                                            y: {
                                                type: 'linear',
                                                position: 'left',
                                                title: {
                                                    display: true,
                                                    text: 'Temperatura (¬∞C)',
                                                    color: '#9ca3af'
                                                },
                                                ticks: { color: '#9ca3af' },
                                                grid: { color: 'rgba(255,255,255,0.05)' }
                                            },
                                            y1: {
                                                type: 'linear',
                                                position: 'right',
                                                min: 0,
                                                max: 1,
                                                title: {
                                                    display: true,
                                                    text: 'NDVI',
                                                    color: '#10b981'
                                                },
                                                ticks: {
                                                    color: '#10b981',
                                                    callback: function (value) {
                                                        return (value).toFixed(1);
                                                    }
                                                },
                                                grid: { display: false }
                                            },
                                            x: {
                                                ticks: { color: '#9ca3af' },
                                                grid: { display: false }
                                            }
                                        }
                                    }
                                });

                            } catch (error) {
                                console.error('Error loading temperature chart:', error);
                            }
                        }

                        // ============================================
                        // NEW: Precipitation Charts (Daily + Accumulated)
                        // ============================================
                        async function loadPrecipitationCharts() {
                            try {
                                // Get forecast data
                                const response = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/weather/forecast?polyid=${polygonId}&appid=${apiKey}`
                                );
                                const forecastData = await response.json();

                                // Process forecast by day
                                const dailyPrecip = {};
                                forecastData.forEach(item => {
                                    const date = new Date(item.dt * 1000);
                                    const dayKey = date.toLocaleDateString('es-PA', {
                                        weekday: 'short',
                                        day: 'numeric'
                                    });

                                    if (!dailyPrecip[dayKey]) {
                                        dailyPrecip[dayKey] = 0;
                                    }

                                    // Add precipitation (rain or snow)
                                    if (item.rain && item.rain['3h']) {
                                        dailyPrecip[dayKey] += item.rain['3h'];
                                    }
                                    if (item.snow && item.snow['3h']) {
                                        dailyPrecip[dayKey] += item.snow['3h'];
                                    }
                                });

                                // Prepare data arrays
                                const labels = Object.keys(dailyPrecip).slice(0, 5);
                                const precipValues = labels.map(day => parseFloat(dailyPrecip[day].toFixed(1)));

                                // Calculate accumulated precipitation
                                const accumValues = [];
                                let accumulated = 0;
                                precipValues.forEach(val => {
                                    accumulated += val;
                                    accumValues.push(parseFloat(accumulated.toFixed(1)));
                                });

                                // Chart 1: Daily Precipitation
                                const ctx1 = document.getElementById('precipChart').getContext('2d');

                                if (window.precipChart && typeof window.precipChart.destroy === 'function') {
                                    window.precipChart.destroy();
                                }

                                window.precipChart = new Chart(ctx1, {
                                    type: 'bar',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Precipitaci√≥n (mm)',
                                            data: precipValues,
                                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                            borderColor: '#3b82f6',
                                            borderWidth: 2,
                                            borderRadius: 8
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                backgroundColor: 'rgba(17, 24, 39, 0.9)',
                                                callbacks: {
                                                    label: function (context) {
                                                        return `${context.parsed.y} mm`;
                                                    }
                                                }
                                            }
                                        },
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                title: {
                                                    display: true,
                                                    text: 'mm',
                                                    color: '#9ca3af'
                                                },
                                                ticks: { color: '#9ca3af' },
                                                grid: { color: 'rgba(255,255,255,0.05)' }
                                            },
                                            x: {
                                                ticks: { color: '#9ca3af' },
                                                grid: { display: false }
                                            }
                                        }
                                    }
                                });

                                // Chart 2: Accumulated Precipitation
                                const ctx2 = document.getElementById('accumPrecipChart').getContext('2d');

                                if (window.accumPrecipChart && typeof window.accumPrecipChart.destroy === 'function') {
                                    window.accumPrecipChart.destroy();
                                }

                                window.accumPrecipChart = new Chart(ctx2, {
                                    type: 'line',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Acumulado (mm)',
                                            data: accumValues,
                                            borderColor: '#8b5cf6',
                                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                                            borderWidth: 3,
                                            fill: true,
                                            tension: 0.3,
                                            pointRadius: 6,
                                            pointBackgroundColor: '#8b5cf6'
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: { display: false },
                                            tooltip: {
                                                backgroundColor: 'rgba(17, 24, 39, 0.9)',
                                                callbacks: {
                                                    label: function (context) {
                                                        return `Total: ${context.parsed.y} mm`;
                                                    }
                                                }
                                            }
                                        },
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                title: {
                                                    display: true,
                                                    text: 'mm acumulados',
                                                    color: '#9ca3af'
                                                },
                                                ticks: { color: '#9ca3af' },
                                                grid: { color: 'rgba(255,255,255,0.05)' }
                                            },
                                            x: {
                                                ticks: { color: '#9ca3af' },
                                                grid: { display: false }
                                            }
                                        }
                                    }
                                });

                            } catch (error) {
                                console.error('Error loading precipitation charts:', error);
                            }
                        }

                        // OpenWeather API Key
                        const openWeatherApiKey = 'ca45f79113069e3524b4877bebe6e0dd';

                        // Load Historical Data Charts (simulated with recent API calls)
                        async function loadHistoricalData() {
                            try {
                                // Fetch historical weather from Agromonitoring (last available data)
                                const response = await fetch(
                                    `https://api.agromonitoring.com/agro/1.0/weather/history?polyid=${polygonId}&start=${Math.floor(Date.now() / 1000) - 86400 * 2}&end=${Math.floor(Date.now() / 1000)}&appid=${apiKey}`
                                );

                                let historicalData = [];

                                // If API returns data, use it; otherwise use sample data
                                if (response.ok) {
                                    historicalData = await response.json();
                                }

                                // If no historical data, generate sample from current conditions
                                if (!historicalData || historicalData.length === 0) {
                                    const now = Date.now();
                                    historicalData = [
                                        { dt: (now - 86400000 * 2) / 1000, main: { temp: 296.8, humidity: 71 }, wind: { speed: 5.6 } },
                                        { dt: (now - 86400000 * 1.5) / 1000, main: { temp: 295.5, humidity: 73 }, wind: { speed: 5.4 } },
                                        { dt: (now - 86400000) / 1000, main: { temp: 294.3, humidity: 77 }, wind: { speed: 5.6 } },
                                        { dt: (now - 43200000) / 1000, main: { temp: 294.2, humidity: 76 }, wind: { speed: 5.6 } },
                                        { dt: now / 1000, main: { temp: 295.4, humidity: 70 }, wind: { speed: 5.9 } }
                                    ];
                                }

                                const labels = historicalData.map(d => {
                                    const date = new Date(d.dt * 1000);
                                    return date.toLocaleDateString('es-ES', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
                                });

                                const temps = historicalData.map(d => Math.round(d.main.temp - 273.15));
                                const humidity = historicalData.map(d => d.main.humidity);
                                const wind = historicalData.map(d => d.wind.speed);

                                // Temperature Chart
                                const tempCtx = document.getElementById('historicalTempChart').getContext('2d');
                                if (window.historicalTempChart && typeof window.historicalTempChart.destroy === 'function') {
                                    window.historicalTempChart.destroy();
                                }
                                window.historicalTempChart = new Chart(tempCtx, {
                                    type: 'line',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Temperatura (¬∞C)',
                                            data: temps,
                                            borderColor: '#f59e0b',
                                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                            borderWidth: 3,
                                            fill: true,
                                            tension: 0.4
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: { legend: { labels: { color: '#f9fafb' } } },
                                        scales: {
                                            y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                            x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                                        }
                                    }
                                });

                                // Humidity Chart
                                const humCtx = document.getElementById('historicalHumidityChart').getContext('2d');
                                if (window.historicalHumidityChart && typeof window.historicalHumidityChart.destroy === 'function') {
                                    window.historicalHumidityChart.destroy();
                                }
                                window.historicalHumidityChart = new Chart(humCtx, {
                                    type: 'line',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Humedad (%)',
                                            data: humidity,
                                            borderColor: '#3b82f6',
                                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                            borderWidth: 3,
                                            fill: true,
                                            tension: 0.4
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: { legend: { labels: { color: '#f9fafb' } } },
                                        scales: {
                                            y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                            x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                                        }
                                    }
                                });

                                // Wind Chart
                                const windCtx = document.getElementById('historicalWindChart').getContext('2d');
                                if (window.historicalWindChart && typeof window.historicalWindChart.destroy === 'function') {
                                    window.historicalWindChart.destroy();
                                }
                                window.historicalWindChart = new Chart(windCtx, {
                                    type: 'bar',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: 'Viento (m/s)',
                                            data: wind,
                                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                                            borderColor: '#10b981',
                                            borderWidth: 2
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: { legend: { labels: { color: '#f9fafb' } } },
                                        scales: {
                                            y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                                            x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                                        }
                                    }
                                });

                            } catch (error) {
                                console.error('Error loading historical data:', error);
                            }
                        }

                        // Load OpenWeather Comparison
                        async function loadOpenWeatherComparison() {
                            try {
                                // Get OpenWeather data
                                const owResponse = await fetch(
                                    `https://api.openweathermap.org/data/2.5/weather?lat=${farmCenter[0]}&lon=${farmCenter[1]}&appid=${openWeatherApiKey}&units=metric`
                                );
                                const owData = await owResponse.json();

                                // Get Agromonitoring data (already loaded, use current values)
                                const agroTemp = document.getElementById('tempValue').textContent;
                                const agroHumidity = document.getElementById('humidityValue').textContent;

                                // Update comparison panel
                                document.getElementById('agroTemp').textContent = agroTemp;
                                document.getElementById('agroHumidity').textContent = agroHumidity;

                                document.getElementById('owTemp').textContent = `${Math.round(owData.main.temp)}¬∞C`;
                                document.getElementById('owHumidity').textContent = `${owData.main.humidity}%`;

                                document.getElementById('comparisonUpdate').textContent =
                                    new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                            } catch (error) {
                                console.error('Error loading OpenWeather comparison:', error);
                            }
                        }
                    </script>
</body>

</html>